<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Generate and align ortomosaics â€¢ canObsR</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Generate and align ortomosaics">
</head>
<body>
<p>








  pkgdown/custom.css

  

  </p>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    pkgdown/home.html

    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">canObsR</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/generate-and-align-ortomosaics.html">Generate and align ortomosaics</a></li>
    <li><a class="dropdown-item" href="../articles/workflow.html">workflow</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/umr-amap/canObsR/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Generate and align ortomosaics</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/umr-amap/canObsR/blob/master/vignettes/generate-and-align-ortomosaics.Rmd" class="external-link"><code>vignettes/generate-and-align-ortomosaics.Rmd</code></a></small>
      <div class="d-none name"><code>generate-and-align-ortomosaics.Rmd</code></div>
    </div>

    
    
<p><img src="img%2Fgenerate_mosaics.JPG" width="40%" style="display: block; margin: auto;"></p>
<p>Here is a short example to guide you step by step through the
orthomosaic generating process and their alignment with the functions <a href="https://umr-amap.github.io/canObsR/reference/generate_Mosa.html"><code>generate_Mosa()</code></a>
and <a href="https://umr-amap.github.io/canObsR/reference/align_Mosa.html"><code>align_Mosa()</code></a>.
These functions required, arosics(AROSICS), the Metashape python API and
a valid Metashape license.</p>
<ul>
<li><p>First you will need to download the <a href="https://zenodo.org/uploads/14748367?token=eyJhbGciOiJIUzUxMiJ9.eyJpZCI6ImVhNjBlZWM5LWYwZTEtNGUxNS04ZDRmLWI3MTAwZTdiMTdmNSIsImRhdGEiOnt9LCJyYW5kb20iOiIzYmViYTgxNWE2OGNlYTA1Zjc1YzdmMWUzZTdjZTVkMSJ9.pzx-dAnjJXNp34OIpqfibrHxZxSUSj8FvdLPGd6r4IaJSa5sAW-eme_EenQr0bLPUAjFGhKrZ-OqrVOQ7bLKBw" class="external-link">test
data</a> and unzip it. Test data contains, 3 sets of drones images from
the same area obtained from 3 differents dates and a
<strong>CHM</strong> canopy height model from the area which is the
reference.</p></li>
<li><p>Then run the following code, more details about the functions <a href="https://umr-amap.github.io/canObsR/reference/generate_Mosa.html"><code>generate_Mosa()</code></a>
and <a href="https://umr-amap.github.io/canObsR/reference/align_Mosa.html"><code>align_Mosa()</code></a>.</p></li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/umr-amap/canObsR" class="external-link">canObsR</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/reticulate/" class="external-link">reticulate</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/use_python.html" class="external-link">use_condaenv</a></span><span class="op">(</span><span class="st">'canObsR_env'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">my_path</span> <span class="op">&lt;-</span> <span class="st">'XXXX/canObsR_data'</span></span>
<span></span>
<span><span class="fu"><a href="../reference/generate_Mosa.html">generate_Mosa</a></span><span class="op">(</span>path_in <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">my_path</span>, <span class="st">'1_my_drone_data'</span><span class="op">)</span>,</span>
<span>          out_dir_ortho <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">my_path</span>, <span class="st">'2_orthomosaics'</span><span class="op">)</span>,</span>
<span>          data_type <span class="op">=</span> <span class="st">"RGB"</span>,</span>
<span>          resol_ref <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>          site_name <span class="op">=</span> <span class="st">"Bouamir"</span>,</span>
<span>          crs <span class="op">=</span> <span class="st">"EPSG:32633"</span>,</span>
<span><span class="op">)</span> </span>
<span></span>
<span><span class="fu"><a href="../reference/align_Mosa.html">align_Mosa</a></span><span class="op">(</span>path_in <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">my_path</span>, <span class="st">'2_orthomosaics'</span><span class="op">)</span>,</span>
<span>        ref_filepath <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">my_path</span>, <span class="st">'Bouamir_LiDAR_ref.tif'</span><span class="op">)</span>,</span>
<span>        out_dir_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">my_path</span>, <span class="st">'3_orthomosaics_aligned'</span><span class="op">)</span>,</span>
<span>        corr_type <span class="op">=</span> <span class="st">"global"</span>,</span>
<span>        <span class="co">#grid_res = 200,</span></span>
<span>        window_size <span class="op">=</span> <span class="fl">500</span>,</span>
<span>        window_pos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">258131</span>, <span class="fl">352973</span><span class="op">)</span>,</span>
<span>        apply_matrix <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        save_data <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="img%2Fgenerate_align_orthomosaics.gif" alt="Non dynamic process of generating and aligning orthomosaics with test data" width="100%"><p class="caption">
Non dynamic process of generating and aligning orthomosaics with test
data
</p>
</div>
<p>When aligning a long time serie of mosaics, you may want to
dynamically register each mosaic to the previous one instead of keeping
one reference for the whole serie, in order to limit the time difference
between a mosaic and its reference.</p>
<p>Here follows a snippet of code that allows you to do just that : the
first image is aligned using the specified reference file, and then each
subsequent image N uses the aligned version of the image N-1 as a
reference.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dir_mosa</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">my_path</span>, <span class="st">'2_orthomosaics'</span><span class="op">)</span></span>
<span><span class="va">out_dir_path</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">my_path</span>, <span class="st">'3_orthomosaics_aligned'</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">PATHs.df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>   path.in <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="va">dir_mosa</span>, full.names <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,</span>
<span>   output_mosa_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="va">dir_mosa</span>, full.names <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span>,</span>
<span>   path_ref <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add reference used for each mosaic</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">PATHs.df</span><span class="op">)</span><span class="op">)</span>                      </span>
<span><span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">i</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>     <span class="va">PATHs.df</span><span class="op">$</span><span class="va">path_ref</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">my_path</span>, <span class="st">'Bouamir_LiDAR_ref.tif'</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="kw">else</span><span class="op">{</span></span>
<span>     <span class="va">PATHs.df</span><span class="op">$</span><span class="va">path_ref</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir_path</span>, <span class="va">PATHs.df</span><span class="op">$</span><span class="va">output_mosa_name</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> </span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Do the alignement with the dynamic alignment process</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">PATHs.df</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="op">{</span></span>
<span>  <span class="va">path_in</span> <span class="op">=</span> <span class="va">PATHs.df</span><span class="op">$</span><span class="va">path_in</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">ref_filepath</span> <span class="op">=</span> <span class="va">PATHs.df</span><span class="op">$</span><span class="va">path_ref</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="fu"><a href="../reference/align_Mosa.html">align_Mosa</a></span><span class="op">(</span>path_in <span class="op">=</span> <span class="va">path_in</span>,</span>
<span>        ref_filepath <span class="op">=</span> <span class="va">ref_filepath</span>,</span>
<span>        out_dir_path <span class="op">=</span> <span class="va">out_dir_path</span>,</span>
<span>        corr_type <span class="op">=</span> <span class="st">"local"</span>,</span>
<span>        grid_res <span class="op">=</span> <span class="fl">200</span>,</span>
<span>        window_size <span class="op">=</span> <span class="fl">500</span>,</span>
<span>        apply_matrix <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        save_data <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>        <span class="op">)</span></span>
<span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"&lt;!&gt; DONE &lt;!&gt;"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"######################################"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="img%2FdynamicCorr.gif" alt="Dynamic process of generating and aligning orthomosaics with test data" width="100%"><p class="caption">
Dynamic process of generating and aligning orthomosaics with test data
</p>
</div>
<p>Note : in this case, both the input and reference images are
potentially heavy mosaics. Depending on their size, it may be useful to
downgrade their resolution to get a faster result without much impact on
quality.</p>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Hugo Leblanc.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>



  pkgdown/footer.html

  
</body>
</html>
