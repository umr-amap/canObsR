---
title: "Create-compatible-crown-delineation-file"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Create-compatible-crown-delineation-file}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Requirements

The extraction of crown images and crown indices requires a compatible crown delineation file. The function [`check_crownFile()`](https://umr-amap.github.io/canObsR/reference/check_crownFile.html) tests each requirement of the file and return the necessary modifications to do to make the file compatible.  

To be compatible with the package functions the crown delineation file must have :  
- at least the variables ‘id’, ‘species’, ‘genus’ and ‘family’  
- ‘species’, ‘genus’ and ‘family’ should not have NA. Replace them by ‘indet’  
- ‘id’ should not have duplicated values.  

# Check the compatibility and adapt the file

The following example shows how to adjust the crown delineation file to make it 
compatible. It uses data from the 

```{r, message=FALSE, warning=FALSE}
library(canObsR)
library(dplyr)

data(crownFile)
glimpse(crownFile)
plot(crownFile$geom, col = 'red')
```

# Adjust the variable names

Check if the variables ‘id’, ‘species’, ‘genus’ and ‘family’ are in the file. Change the variable names or create empty variables if you do not have the information. id must be <int> or <num> and ‘species’, ‘genus’ and ‘family’ must be <chr>.

```{r, message=FALSE, warning=FALSE}
check_crownFile(crownFile)

crownFile = crownFile %>% 
   rename(
      family = tax_fam,         # Rename the corresponding variable as 'family'
      genus = tax_gen,          # Rename the corresponding variable as 'genus'
      species = tx_sp_lvl       # Rename the corresponding variable as 'species'
   )
```

# Replace NA by 'indet'

Check if you have NA in ‘id’, ‘species’, ‘genus’ and ‘family’ variables. NA from ‘species’, ‘genus’ and ‘family’ must be replace by 'indet' and just NA from 'id'.

```{r, message=FALSE, warning=FALSE}
check_crownFile(crownFile)


crownFile = crownFile %>% mutate(
      # Rename NA to 'indet' in the family variable
      family = case_when(is.na(family)~ 'indet', TRUE ~ family),
      # Same for genus
      genus = case_when(is.na(genus)~ 'indet', TRUE ~ genus),
      # Same for species
      species = case_when(is.na(species)~ paste(genus, 'indet'), TRUE ~ species)
      ) %>% 
   filter(!is.na(id))
```

# Last check

When the function does not indicate error, the file is compatible !
```{r, message=FALSE, warning=FALSE}
check_crownFile(crownFile)
```

